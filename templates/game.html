{{define "game"}}
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Click Trainer - Target Game</title>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <script src="https://unpkg.com/htmx-ext-sse@2.2.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.js"></script>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" href="/static/favicon.ico">
</head>

<body hx-ext="sse" sse-connect="/room/events" data-scene="{{.Scene}}">
    <div class="gradient-overlay"></div>
    <div class="parallax-container">
        <div class="parallax-layer stars"></div>
        <div class="parallax-layer cloud-1">
            <img src="/static/cloud-1.svg" />
            <img src="/static/cloud-1.svg" />
        </div>
        <div class="parallax-layer cloud-2">
            <img src="/static/cloud-2.svg" />
            <img src="/static/cloud-2.svg" />
        </div>
    </div>
    <div class="hills"></div>
    <div class="p-4 h-screen relative" style="z-index:10;">
        <div id="scene"
            class="relative h-full flex flex-col justify-center items-center md:scale-130 lg:scale-160 xl:scale-180 2xl:scale-200 3xl:scale-230 4xl:scale-260">
            {{if eq .Scene "lobby"}}
            {{template "lobby" .}}
            {{else if eq .Scene "recap"}}
            {{template "recap" .Rankings}}
            {{else}}
            {{template "gameContent" .}}
            {{end}}
        </div>
    </div>
    <div sse-swap="swap" hx-swap="true"></div>
    <div sse-swap="sceneChange" style="display:none;" hx-on:htmx:after-swap="document.body.setAttribute('data-scene', this.textContent)"></div>
    <div id="game-content-conn" hx-trigger="sse:update" hx-get="/room/poll" hx-target="#game-content" hx-swap="innerHTML">
    </div>

    <!-- Mute button -->
    <button type="button" id="mute-btn" onclick="toggleMuteBtn()"
        class="fixed top-4 right-4 z-50 bg-black/40 hover:bg-black/60 text-white rounded-full w-10 h-10 flex items-center justify-center cursor-pointer"
        title="Toggle sound">
        <span id="mute-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
            </svg>
        </span>
    </button>

    <script>
    // ===== QR Code & Sharing =====
    function generateQR() {
        var container = document.getElementById('qr-code');
        if (!container) return;
        container.innerHTML = '';
        var qr = qrcode(0, 'M');
        qr.addData(window.location.href);
        qr.make();
        container.innerHTML = qr.createSvgTag(2, 0);
    }

    function shareRoom() {
        var url = window.location.href;
        if (navigator.share) {
            navigator.share({ title: 'Join my Click Trainer room!', url: url }).catch(function() {});
        } else {
            copyRoomLink();
        }
    }

    function copyRoomLink() {
        navigator.clipboard.writeText(window.location.href).then(function() {
            var toast = document.createElement('div');
            toast.className = 'copy-toast';
            toast.textContent = 'Link copied!';
            document.body.appendChild(toast);
            setTimeout(function() { toast.remove(); }, 1500);
        });
    }

    // Hide share button if Web Share API unavailable
    if (!navigator.share) {
        var shareBtn = document.getElementById('share-btn');
        if (shareBtn) shareBtn.style.display = 'none';
    }

    // Generate QR on load and after OOB swaps (Play Again)
    generateQR();
    document.body.addEventListener('htmx:oobAfterSwap', function() {
        setTimeout(generateQR, 50);
    });

    // ===== WebSocket Client for Combat Clicks + Cursor Sharing =====
    window.GameWS = (function() {
        var ws = null;
        var connected = false;
        var cursors = {}; // playerID -> DOM element
        var lastMoveTime = 0;
        var THROTTLE_MS = 50;

        function connect() {
            if (ws) return;
            var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            var url = proto + '//' + location.host + '/room/ws';
            ws = new WebSocket(url);
            ws.onopen = function() {
                connected = true;
                setupCursorTracking();
            };
            ws.onclose = function() { ws = null; connected = false; };
            ws.onerror = function() { ws = null; connected = false; };
            ws.onmessage = function(e) {
                var msg;
                try { msg = JSON.parse(e.data); } catch(_) { return; }
                switch (msg.t) {
                    case 'move': handleRemoteMove(msg); break;
                    case 'kill': handleRemoteKill(msg); break;
                    case 'leave': handleRemoteLeave(msg); break;
                }
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
                connected = false;
            }
            cleanupCursors();
        }

        function sendClick(targetId, points) {
            if (ws && connected) {
                ws.send(JSON.stringify({t: 'click', id: targetId, p: points}));
                return true;
            }
            return false;
        }

        function isConnected() { return connected; }

        // --- Cursor tracking ---
        function setupCursorTracking() {
            var gameArea = document.getElementById('game-area');
            if (!gameArea || gameArea._cursorTracking) return;
            gameArea._cursorTracking = true;
            gameArea.addEventListener('mousemove', function(e) {
                var now = Date.now();
                if (now - lastMoveTime < THROTTLE_MS) return;
                lastMoveTime = now;
                if (!ws || !connected) return;
                var rect = gameArea.getBoundingClientRect();
                var scaleX = rect.width / gameArea.offsetWidth;
                var scaleY = rect.height / gameArea.offsetHeight;
                var x = Math.round((e.clientX - rect.left) / scaleX);
                var y = Math.round((e.clientY - rect.top) / scaleY);
                ws.send(JSON.stringify({t: 'move', x: x, y: y}));
            });
        }

        // --- Remote cursor ---
        function handleRemoteMove(msg) {
            var gameArea = document.getElementById('game-area');
            if (!gameArea) return;
            var el = cursors[msg.id];
            if (!el) {
                el = document.createElement('div');
                el.className = 'player-cursor';
                el.setAttribute('data-player-id', msg.id);
                el.style.setProperty('--cursor-color', msg.c || '#ffffff');
                var label = document.createElement('span');
                label.className = 'player-cursor-label';
                label.textContent = msg.n || '';
                label.style.color = msg.c || '#ffffff';
                el.appendChild(label);
                gameArea.appendChild(el);
                cursors[msg.id] = el;
            }
            el.style.transform = 'translate(' + msg.x + 'px, ' + msg.y + 'px)';
        }

        // --- Remote kill effect ---
        function handleRemoteKill(msg) {
            var gameArea = document.getElementById('game-area');
            if (!gameArea) return;
            var el = document.createElement('div');
            el.className = 'kill-effect';
            el.style.left = msg.x + 'px';
            el.style.top = msg.y + 'px';

            var ripple = document.createElement('div');
            ripple.className = 'kill-ripple';
            ripple.style.borderColor = msg.c || '#ffffff';
            el.appendChild(ripple);

            var label = document.createElement('div');
            label.className = 'kill-label';
            label.textContent = msg.n + ' +' + msg.p;
            label.style.backgroundColor = msg.c || '#ffffff';
            el.appendChild(label);

            gameArea.appendChild(el);
            setTimeout(function() { el.remove(); }, 1000);
        }

        // --- Remote leave ---
        function handleRemoteLeave(msg) {
            var el = cursors[msg.id];
            if (el) {
                el.remove();
                delete cursors[msg.id];
            }
        }

        function cleanupCursors() {
            for (var id in cursors) {
                cursors[id].remove();
            }
            cursors = {};
        }

        // Manage lifecycle based on data-scene attribute
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(m) {
                if (m.type === 'attributes' && m.attributeName === 'data-scene') {
                    var scene = document.body.getAttribute('data-scene');
                    if (scene === 'combat') {
                        connect();
                    } else {
                        disconnect();
                    }
                }
            });
        });
        observer.observe(document.body, { attributes: true, attributeFilter: ['data-scene'] });

        // Connect immediately if already in combat
        if (document.body.getAttribute('data-scene') === 'combat') {
            connect();
        }

        return { sendClick: sendClick, isConnected: isConnected, connect: connect, disconnect: disconnect };
    })();

    // ===== Hit Feedback (Points Popup + Shake + Particles) =====
    document.addEventListener('mousedown', function(e) {
        var circle = e.target.closest('circle[data-points]');
        if (!circle) return;

        var points = parseInt(circle.getAttribute('data-points'), 10);
        if (!points) return;

        var targetDiv = circle.closest('[data-target-id]');
        if (!targetDiv) return;
        var targetId = parseInt(targetDiv.getAttribute('data-target-id'), 10);

        // Send click via WebSocket, fall back to HTTP POST
        if (!window.GameWS || !window.GameWS.sendClick(targetId, points)) {
            fetch('/room/target/' + targetId + '/' + points, {method: 'POST', credentials: 'same-origin'});
        }

        var gameArea = document.getElementById('game-area');
        if (!gameArea) return;

        var rect = gameArea.getBoundingClientRect();
        var scaleX = rect.width / gameArea.offsetWidth;
        var scaleY = rect.height / gameArea.offsetHeight;
        var x = (e.clientX - rect.left) / scaleX;
        var y = (e.clientY - rect.top) / scaleY;

        spawnPointsPopup(gameArea, x, y, points);
        triggerScreenShake(gameArea);
        spawnBurstParticles(gameArea, x, y);

        if (window.SoundEngine) SoundEngine.playHit(points);
    });

    function spawnPointsPopup(container, x, y, points) {
        var el = document.createElement('div');
        el.className = 'points-popup';
        el.textContent = '+' + points;
        var colors = ['#ffffff', '#ffeb3b', '#ff9800', '#ffd700'];
        var idx = points <= 1 ? 0 : points <= 2 ? 1 : points <= 3 ? 2 : 3;
        el.style.color = colors[idx];
        el.style.fontSize = (1.2 + points * 0.3) + 'rem';
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        container.appendChild(el);
        setTimeout(function() { el.remove(); }, 600);
    }

    function triggerScreenShake(el) {
        el.classList.remove('screen-shake');
        void el.offsetWidth;
        el.classList.add('screen-shake');
        setTimeout(function() { el.classList.remove('screen-shake'); }, 150);
    }

    function spawnBurstParticles(container, x, y) {
        var palette = ['#ef4444','#facc15','#22c55e','#3b82f6','#f97316','#a855f7'];
        for (var i = 0; i < 8; i++) {
            var el = document.createElement('div');
            el.className = 'burst-particle';
            var angle = (Math.PI * 2 / 8) * i;
            var dist = 20 + Math.random() * 20;
            el.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
            el.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.style.backgroundColor = palette[i % palette.length];
            container.appendChild(el);
            setTimeout(function(e) { e.remove(); }, 400, el);
        }
    }

    // ===== Sound Engine (Web Audio API) =====
    window.SoundEngine = (function() {
        var ctx = null;
        var muted = localStorage.getItem('clicktrainer_muted') === 'true';

        function getCtx() {
            if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
            return ctx;
        }

        function playHit(points) {
            if (muted) return;
            var c = getCtx();
            var osc = c.createOscillator();
            var gain = c.createGain();
            osc.type = 'sine';
            var freqs = [400, 520, 660, 880];
            var idx = points <= 1 ? 0 : points <= 2 ? 1 : points <= 3 ? 2 : 3;
            osc.frequency.value = freqs[idx];
            gain.gain.setValueAtTime(0.3, c.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, c.currentTime + 0.15);
            osc.connect(gain);
            gain.connect(c.destination);
            osc.start(c.currentTime);
            osc.stop(c.currentTime + 0.15);
        }

        function playCountdownBeep() {
            if (muted) return;
            var c = getCtx();
            var osc = c.createOscillator();
            var gain = c.createGain();
            osc.type = 'square';
            osc.frequency.value = 600;
            gain.gain.setValueAtTime(0.15, c.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, c.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(c.destination);
            osc.start(c.currentTime);
            osc.stop(c.currentTime + 0.1);
        }

        function playGameStart() {
            if (muted) return;
            var c = getCtx();
            var notes = [523, 659, 784]; // C5, E5, G5
            notes.forEach(function(freq, i) {
                var osc = c.createOscillator();
                var gain = c.createGain();
                osc.type = 'sine';
                osc.frequency.value = freq;
                var t = c.currentTime + i * 0.12;
                gain.gain.setValueAtTime(0.2, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
                osc.connect(gain);
                gain.connect(c.destination);
                osc.start(t);
                osc.stop(t + 0.2);
            });
        }

        function playRoundEnd() {
            if (muted) return;
            var c = getCtx();
            var osc = c.createOscillator();
            var gain = c.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, c.currentTime);
            osc.frequency.linearRampToValueAtTime(300, c.currentTime + 0.5);
            gain.gain.setValueAtTime(0.2, c.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, c.currentTime + 0.5);
            osc.connect(gain);
            gain.connect(c.destination);
            osc.start(c.currentTime);
            osc.stop(c.currentTime + 0.5);
        }

        function toggleMute() {
            muted = !muted;
            localStorage.setItem('clicktrainer_muted', muted);
            return muted;
        }

        function isMuted() { return muted; }

        return { playHit: playHit, playCountdownBeep: playCountdownBeep, playGameStart: playGameStart, playRoundEnd: playRoundEnd, toggleMute: toggleMute, isMuted: isMuted };
    })();

    // Mute button
    function updateMuteIcon() {
        var icon = document.getElementById('mute-icon');
        if (!icon) return;
        if (SoundEngine.isMuted()) {
            icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>';
        } else {
            icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>';
        }
    }

    function toggleMuteBtn() {
        SoundEngine.toggleMute();
        updateMuteIcon();
    }

    updateMuteIcon();

    // Sound triggers for countdown and scene changes
    (function() {
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(m) {
                // Countdown beep — watch for #countdown_num content changes
                if (m.type === 'childList') {
                    m.addedNodes.forEach(function(node) {
                        if (node.id === 'countdown_num' || (node.querySelector && node.querySelector('#countdown_num'))) {
                            SoundEngine.playCountdownBeep();
                        }
                    });
                }
                // Scene change — watch data-scene attribute
                if (m.type === 'attributes' && m.attributeName === 'data-scene') {
                    var scene = document.body.getAttribute('data-scene');
                    if (scene === 'combat') SoundEngine.playGameStart();
                    if (scene === 'recap') SoundEngine.playRoundEnd();
                }
            });
        });
        observer.observe(document.body, { childList: true, subtree: true, attributes: true, attributeFilter: ['data-scene'] });
    })();
    </script>
</body>

</html>
{{end}}

{{define "gameContent"}}

    <div class="flex flex-row items-center gap-4 w-full justify-center">
        {{template "scoreboard" .Players}}
        <div id="timer" class="bg-black/40 text-white rounded-lg p-1 px-2 text-sm font-bold tabular-nums tracking-wider">{{.TimeLeft}}</div>
    </div>
    <div id="game-area" class="relative">
        <div id="targets">
            {{range .Targets}}
            {{template "target" .}}
            {{end}}
            <div sse-swap="newTarget" hx-swap="beforebegin"></div>
        </div>
    </div>

{{end}}

{{define "scoreboard"}}
<div id="scoreboard" sse-swap="scoreboard" hx-swap="outerHTML" class="flex flex-row flex-wrap gap-2 p-1 text-sm">
    {{range .}}
    <div id="player_{{.ID}}" class="flex flex-row items-center gap-2 px-3 py-1.5 rounded-lg" style="background-color:{{.Color}}33; border: 2px solid {{.Color}};">
        <div class="w-3 h-3 rounded-full" style="background-color:{{.Color}}"></div>
        <label class="text-white font-bold">{{ .Name }}</label>
        <div id="player_score_{{ .ID }}" class="bg-white/20 px-2 py-0.5 rounded-md text-white">{{ .Score}}</div>
    </div>
    {{end}}
</div>
{{end}}
